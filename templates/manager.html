<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEN-PURE | POSTE DE COMMANDEMENT OMEGA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        #map { height: 450px; border-radius: 2rem; border: 1px solid rgba(59, 130, 246, 0.2); z-index: 10; }
        .vision-btn { display: none; transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-[#020617] text-slate-100 font-sans antialiased overflow-x-hidden">

    <div class="flex h-screen">
        <aside class="w-64 glass border-r border-white/5 p-6 hidden lg:flex flex-col">
            <div class="mb-10 text-center">
                <h1 class="text-xl font-black italic text-blue-500 uppercase tracking-tighter">GEN-PURE OMEGA</h1>
                <p class="text-[9px] text-slate-500 tracking-widest uppercase mt-1">Haut Commandement</p>
            </div>
            <nav class="space-y-2 flex-1">
                <a href="/manager" class="flex items-center space-x-3 text-blue-400 bg-blue-500/10 p-3 rounded-xl border border-blue-500/20">
                    <i class="fas fa-satellite-dish"></i><span class="font-bold">Dashboard</span>
                </a>
                <a href="/scan" class="flex items-center space-x-3 text-slate-400 hover:text-white p-3 rounded-xl hover:bg-white/5 transition-all">
                    <i class="fas fa-barcode"></i><span>Unité de Scan</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 lg:p-8">
            
            <div id="vision-bar" class="vision-btn mb-6 glass p-4 rounded-2xl border border-blue-500/50 flex justify-between items-center bg-blue-600/10">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-eye text-blue-500 text-xl animate-pulse"></i>
                    <div>
                        <h4 class="text-xs font-black uppercase">Mode Vision Activé</h4>
                        <p class="text-[10px] text-slate-400">2 rapports sélectionnés pour analyse comparative.</p>
                    </div>
                </div>
                <button onclick="launchVision()" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black px-6 py-2 rounded-xl transition-all uppercase">
                    Lancer Comparaison
                </button>
            </div>

            <div class="glass p-2 rounded-[2rem] mb-8">
                <div id="map"></div>
            </div>

            <div class="glass rounded-3xl overflow-hidden mb-10">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-widest text-blue-400">Registre de Flotte</h3>
                    <span class="text-[9px] text-slate-500">SÉLECTIONNEZ 2 RAPPORTS POUR COMPARER</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="scans-table">
                        <thead class="bg-white/5 text-[10px] text-slate-500 uppercase">
                            <tr>
                                <th class="p-4 w-10">Vision</th>
                                <th class="p-4">ID Rapport</th>
                                <th class="p-4">Station</th>
                                <th class="p-4">Verdict</th>
                                <th class="p-4">Date</th>
                                <th class="p-4">PDF</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {% for point in map_points %}
                            <tr class="hover:bg-white/5 transition-all">
                                <td class="p-4">
                                    <input type="checkbox" value="{{ point.report_id }}" onchange="handleSelection(this)" 
                                           class="w-4 h-4 rounded border-white/10 bg-slate-900 checked:bg-blue-600 focus:ring-blue-500 transition-all cursor-pointer">
                                </td>
                                <td class="p-4 font-mono text-blue-500 text-xs">#{{ point.report_id }}</td>
                                <td class="p-4 font-bold">{{ point.station }}</td>
                                <td class="p-4">
                                    <span class="px-3 py-1 rounded-full text-[9px] font-black 
                                        {% if point.risk == 'DANGER' %} bg-red-600 {% elif point.risk == 'VIGILANCE' %} bg-orange-600 {% else %} bg-emerald-600 {% endif %}">
                                        {{ point.status }}
                                    </span>
                                </td>
                                <td class="p-4 text-slate-400 text-xs">{{ point.timestamp }}</td>
                                <td class="p-4">
                                    <a href="/static/reports/CERT-{{ point.report_id }}.pdf" target="_blank" class="text-slate-500 hover:text-white">
                                        <i class="fas fa-file-invoice"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let selectedScans = [];

        function handleSelection(checkbox) {
            if (checkbox.checked) {
                if (selectedScans.length >= 2) {
                    checkbox.checked = false;
                    alert("Mon Général, l'Agent VISION ne peut comparer que 2 rapports à la fois.");
                    return;
                }
                selectedScans.push(checkbox.value);
            } else {
                selectedScans = selectedScans.filter(id => id !== checkbox.value);
            }

            // Affichage dynamique de la barre VISION
            const visionBar = document.getElementById('vision-bar');
            visionBar.style.display = (selectedScans.length === 2) ? 'flex' : 'none';
        }

        function launchVision() {
            if (selectedScans.length === 2) {
                window.location.href = `/manager/compare?id1=${selectedScans[0]}&id2=${selectedScans[1]}`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map', { zoomControl: false }).setView([4.05, 9.7], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

            const mapData = JSON.parse('{{ map_points | tojson | safe }}' || '[]');
            mapData.forEach(point => {
                const color = point.risk === 'DANGER' ? '#ef4444' : (point.risk === 'VIGILANCE' ? '#f97316' : '#10b981');
                L.circleMarker([4.05 + (Math.random() - 0.5) * 0.1, 9.7 + (Math.random() - 0.5) * 0.1], {
                    radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9
                }).addTo(map).bindPopup(`<b>${point.station}</b><br>ID: ${point.report_id}`);
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEN-PURE - Nouveau Scan</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: #1e3a8a; margin-bottom: 25px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        select, input[type="text"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        #manual_origin_div { display: none; margin-top: 10px; }
        #preview { width: 100%; border-radius: 12px; margin-top: 15px; display: none; border: 2px solid #e5e7eb; }
        .btn-analyze { background: #1e3a8a; color: white; width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: background 0.3s; }
        .btn-analyze:hover { background: #1e40af; }
        .result-card { margin-top: 20px; padding: 20px; border-radius: 12px; display: none; text-align: left; }
        .critical { background: #fee2e2; border-left: 5px solid #dc2626; color: #991b1b; }
        .success { background: #dcfce7; border-left: 5px solid #16a34a; color: #166534; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üî¨ Analyse de Puret√©</h2>
        
        <div class="form-group">
            <label>üìç Origine / Station :</label>
            <select id="station_select" onchange="toggleManualInput()">
                <option value="Station Alpha">Station Alpha</option>
                <option value="Station Beta">Station Beta</option>
                <option value="D√©p√¥t Central">D√©p√¥t Central</option>
                <option value="Camion Citerne">Arrivage Camion</option>
                <option value="MANUAL">-- Autre (Saisir manuellement) --</option>
            </select>
            
            <div id="manual_origin_div">
                <label>Nom de la nouvelle origine :</label>
                <input type="text" id="manual_station_name" placeholder="Ex: Cuve Mobile 04">
            </div>
        </div>

        <div class="form-group">
            <label>üì∏ Photo de l'√©chantillon :</label>
            <input type="file" id="image_input" accept="image/*" capture="environment">
            <small style="color: #666;">Prenez une photo ou choisissez un fichier dans la galerie</small>
        </div>

        <img id="preview" alt="Aper√ßu du scan">

        <button id="run_analysis" class="btn-analyze">Lancer l'Analyse</button>

        <div id="resultBox" class="result-card">
            <h3 id="resStatus">--</h3>
            <p><strong>Turbidit√© :</strong> <span id="resTurb">0</span>%</p>
            <p><strong>Eau d√©tect√©e :</strong> <span id="resWater">Non</span></p>
            <p><strong>Impuret√©s :</strong> <span id="resPart">0</span></p>
            <p id="resAdvice" style="font-weight: bold; margin-top: 10px;"></p>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('image_input');
        const preview = document.getElementById('preview');
        const runBtn = document.getElementById('run_analysis');

        function toggleManualInput() {
            const select = document.getElementById('station_select');
            const manualDiv = document.getElementById('manual_origin_div');
            manualDiv.style.display = (select.value === 'MANUAL') ? 'block' : 'none';
        }

        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        runBtn.addEventListener('click', async () => {
            const file = imageInput.files[0];
            let station = document.getElementById('station_select').value;
            
            if (station === 'MANUAL') {
                station = document.getElementById('manual_station_name').value;
            }

            if (!file || !station) {
                alert("Veuillez renseigner l'origine et choisir une photo.");
                return;
            }

            runBtn.innerText = "Analyse en cours...";
            const formData = new FormData();
            formData.append('file', file);
            formData.append('station', station);

            try {
                const response = await fetch('/api/detection/detect', { method: 'POST', body: formData });
                const data = await response.json();

                const box = document.getElementById('resultBox');
                box.style.display = 'block';
                box.className = 'result-card ' + (data.status === 'CONFORME' ? 'success' : 'critical');
                
                document.getElementById('resStatus').innerText = "R√©sultat : " + data.status;
                document.getElementById('resTurb').innerText = data.turbidity;
                document.getElementById('resWater').innerText = data.water_present ? "OUI (Pr√©sence d'eau !)" : "Non (Absence d'eau)";
                document.getElementById('resPart').innerText = data.impurities_found + " particules d√©tect√©es";
                document.getElementById('resAdvice').innerText = data.recommendation;
            } catch (err) {
                alert("Erreur de connexion avec le serveur.");
            } finally {
                runBtn.innerText = "Lancer l'Analyse";
            }
        });
    </script>
</body>
</html>
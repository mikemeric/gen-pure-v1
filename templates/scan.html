<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEN-PURE | SCANNER OMEGA CAMEROUN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        #video-preview { width: 100%; height: 280px; object-fit: cover; border-radius: 2rem; border: 2px solid #3b82f6; }
        .scanner-laser {
            position: absolute; inset: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(59, 130, 246, 0.4) 50%);
            background-size: 100% 8px;
            animation: scan 4s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { from { transform: translateY(-100%); } to { transform: translateY(100%); } }
    </style>
</head>
<body class="bg-slate-950 text-white flex flex-col h-screen overflow-hidden font-sans">

    <header class="p-4 flex justify-between items-center glass border-b border-white/5">
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            <h1 class="text-lg font-black italic tracking-tighter uppercase">Sentinel <span class="text-blue-500">CMR</span></h1>
        </div>
        <a href="/manager" class="text-[10px] font-black uppercase text-slate-400 bg-white/5 px-4 py-2 rounded-xl">Dashboard</a>
    </header>

    <main class="flex-1 p-5 space-y-5 overflow-y-auto">
        <div class="relative glass rounded-[2.5rem] overflow-hidden shadow-2xl">
            <video id="video-preview" autoplay playsinline></video>
            <div class="scanner-laser"></div>
        </div>

        <div class="space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Type d'Actif</label>
                <select id="asset-category" class="w-full bg-slate-900 border border-white/10 p-4 rounded-2xl text-sm font-bold outline-none focus:border-blue-500">
                    <option value="STATION">STATION SERVICE</option>
                    <option value="CAMION">FLOTTE CAMION / CITERNE</option>
                    <option value="GE">GROUPE √âLECTROG√àNE</option>
                </select>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black uppercase text-slate-500 ml-2">Source du Pr√©l√®vement</label>
                <select id="station-preset" onchange="toggleManualInput()" class="w-full bg-slate-900 border border-white/10 p-4 rounded-2xl text-sm font-bold outline-none focus:border-blue-500">
                    <optgroup label="DOUALA (Secteurs)">
                        <option value="TRADEX-AKWA">Tradex - Akwa</option>
                        <option value="TOTAL-BONABERI">TotalEnergies - Bonab√©ri</option>
                        <option value="BOCOM-BEPANDA">Bocom - B√©panda</option>
                        <option value="MRS-DEIDO">MRS - Deido</option>
                        <option value="NEPTUNE-LOGBABA">Neptune - Logbaba</option>
                        <option value="STATION-YASSA">Station - Yassa</option>
                    </optgroup>
                    <optgroup label="YAOUND√â (Secteurs)">
                        <option value="TRADEX-MVAN">Tradex - Mvan</option>
                        <option value="TOTAL-BASTOS">TotalEnergies - Bastos</option>
                        <option value="BOCOM-ESSOS">Bocom - Essos</option>
                        <option value="MRS-CENTRE-VILLE">MRS - Centre Ville</option>
                        <option value="NEPTUNE-ODZA">Neptune - Odza</option>
                    </optgroup>
                    <option value="MANUAL">-- SAISIE MANUELLE (HORS R√âSEAU) --</option>
                </select>
                <input type="text" id="station-manual" placeholder="Nom de l'actif ou Station personnalis√©e..." 
                       class="hidden w-full bg-blue-500/10 border border-blue-500/30 p-4 rounded-2xl text-sm outline-none mt-2 focus:border-blue-500">
            </div>
        </div>

        <button id="capture-trigger" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-500/30 active:scale-95 transition-all uppercase tracking-widest text-xs">
            <i class="fas fa-bolt mr-2"></i> Lancer Diagnostic IA
        </button>
    </main>

    <div id="result-modal" class="fixed inset-0 bg-slate-950/98 z-[100] hidden flex flex-col items-center justify-center p-8 text-center">
        <div id="status-icon" class="text-7xl mb-6"></div>
        <h2 id="status-title" class="text-3xl font-black mb-2 italic uppercase"></h2>
        <div id="status-box" class="bg-white/5 p-5 rounded-3xl border border-white/5 mb-8 w-full">
            <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">R√©sultat Laboratoire OMEGA</p>
            <p id="status-ntu" class="text-2xl font-black text-blue-400"></p>
        </div>
        <p id="status-desc" class="text-slate-400 text-sm mb-10 leading-relaxed"></p>
        <button onclick="location.reload()" class="bg-white text-black font-black px-12 py-4 rounded-full text-[10px] uppercase tracking-widest">Nouveau Scan</button>
    </div>

    <canvas id="capture-canvas" class="hidden"></canvas>

    <script>
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('capture-canvas');
        const trigger = document.getElementById('capture-trigger');

        function toggleManualInput() {
            const select = document.getElementById('station-preset');
            const manual = document.getElementById('station-manual');
            manual.classList.toggle('hidden', select.value !== 'MANUAL');
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) { alert("Acc√®s Cam√©ra requis."); }
        }

        trigger.addEventListener('click', async () => {
            trigger.disabled = true;
            trigger.innerHTML = '<i class="fas fa-sync animate-spin"></i> CALCUL EN COURS...';

            let source = document.getElementById('station-preset').value;
            if(source === 'MANUAL') source = document.getElementById('station-manual').value || 'HORS-RESEAU';
            
            const category = document.getElementById('asset-category').value;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'scan.jpg');
                formData.append('station', source);
                formData.append('category', category);

                try {
                    const response = await fetch('/api/detection/detect', { method: 'POST', body: formData });
                    const res = await response.json();
                    showResult(res);
                } catch (err) { 
                    alert("Erreur de communication.");
                    trigger.disabled = false;
                }
            }, 'image/jpeg', 0.8);
        });

        function showResult(res) {
            const modal = document.getElementById('result-modal');
            modal.classList.remove('hidden');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            
            document.getElementById('status-ntu').innerText = (res.turbidity || "0") + " NTU";

            if(res.risk_level === 'REJET') {
                icon.innerHTML = '‚ö†Ô∏è'; title.innerText = "REFUS ANALYSE"; title.className = "text-orange-500 text-3xl font-black";
                document.getElementById('status-box').style.display = 'none';
            } else if(res.risk_level === 'DANGER') {
                icon.innerHTML = 'üö®'; title.innerText = "DANGER"; title.className = "text-red-500 text-3xl font-black";
            } else {
                icon.innerHTML = '‚úÖ'; title.innerText = "CONFORME"; title.className = "text-emerald-500 text-3xl font-black";
            }
            document.getElementById('status-desc').innerText = res.diagnostic;
        }

        initCamera();
    </script>
</body>
</html>